<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <!-- The CSS package above applies Google styling to buttons and other elements. -->

  <style>
    .branding-below {
      bottom: 56px;
      top: 0;
    }
    .branding-text {
      left: 7px;
      position: relative;
      top: 3px;
    }
    .col-contain {
      overflow: hidden;
    }
    .col-one {
      float: left;
      width: 50%;
    }
    .logo {
      vertical-align: middle;
    }
    .radio-spacer {
      height: 20px;
    }
    .width-100 {
      width: 100%;
    }
  </style>
  <title></title>
</head>
<body>

<div class="sidebar branding-below">
  <form>
    <div class="block" id="button-bar">
      <button class="blue" id="end-sprint" style="display: none;">End Sprint ()</button>
    </div>
    <div class="block" id="button-bar">
      <button class="blue" id="clear-history">Clear History</button>
    </div>
  </form>
  <pre id="bwdata"></pre>
</div>

<div class="sidebar bottom" style="vertical-align: middle;">
  <svg
   viewBox="0 0 16.933333 16.933334"
   version="1.1"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg"
   style="width: 2em; height: 2em; vertical-align: middle;"
   >
    <path
      style="fill:#ffff4b;fill-opacity:1;stroke:#bb0000;stroke-width:1.13771;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
      d="m 1.600913,3.9476634 2.722949,0.00676 0.7859209,-2.9224299 3.446102,1.366659 3.2577631,-1.3634906 0.364028,2.9076815 3.539833,1.6758764 -1.964058,3.3290998 1.762107,3.4388229 -3.83143,-0.343231 -0.976427,3.226047 -3.1515024,-2.863674 -2.4597903,2.796026 -0.318583,-5.2687725 -3.2730542,-0.776812 2.2040087,-2.55562 z"
      />
    <path
      style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.15875;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
      d="M 3.9959824,11.714105 3.3392534,9.2914837 c 0,0 0.5228746,-0.8388269 0.9049872,-1.3557743 C 4.3168,7.8375463 4.5230394,9.0325779 4.917453,9.2055853 4.7593691,8.3919244 4.6661854,7.4602037 4.738456,7.3622058 5.52501,6.2956486 6.2500972,5.3813355 7.0447057,4.7327813 7.4458297,4.4053867 7.8386513,4.1288157 8.2330095,3.8900832 8.3733275,3.8051389 8.3076951,4.7861846 8.683558,5.2066784 8.6726344,4.6178375 8.7104281,3.6473604 8.8297701,3.5893212 9.5790086,3.2249468 10.537509,2.84069 11.406887,2.5967013 13.04493,2.1369886 16.750275,1.8417119 16.750275,1.8417119 c 0,0 -1.692267,2.6488402 -2.867748,3.8114861 -0.221928,0.2195033 -0.472369,0.4214557 -0.741105,0.6120332 -0.08369,0.059352 -0.579761,-0.6223182 -0.8462,-0.8965891 -0.0014,0.6074707 0.429422,1.1759104 0.347469,1.2270919 C 11.581129,7.2587006 10.352718,7.8164481 9.4751016,8.5817375 9.1204178,8.8910248 8.738661,9.3083703 8.3733794,9.7481209 8.3067063,9.8283864 7.8197802,9.390126 7.4776902,8.9727809 7.5077082,9.712836 8.0008698,10.209812 7.9165281,10.318743 7.1909762,11.255819 6.6224331,12.12907 6.6224331,12.12907 Z"
      />
    <path
      style="fill:#000000;fill-opacity:1;stroke:none;stroke-width:0.264583px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
      d="m 0.89424243,14.982203 c -0.1251334,-0.663454 0.70440197,-1.722414 1.42633397,-1.773666 0.721932,-0.05125 1.5171914,0.755073 1.5095132,1.411254 -0.00768,0.65618 -0.7918175,1.182374 -1.3961717,1.245359 -0.6043542,0.06298 -1.4145422,-0.219492 -1.53967547,-0.882947 z"
      />
    <path
      style="fill:#ffffff;fill-opacity:1;stroke:#000000;stroke-width:0.423862;stroke-linecap:square;stroke-linejoin:miter;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"
      d="m 1.4289005,14.985606 c 0,0 3.4465102,-5.6272157 5.7165813,-7.7675205 C 9.4155526,5.0777807 14.780259,2.5917048 14.780259,2.5917048 L 14.028592,3.7021446 C 12.220889,4.6758987 9.6108316,6.2043588 7.9381069,7.6901418 6.265382,9.1759247 2.6236346,14.759321 2.6236346,14.759321 Z"
      />
  </svg>

  <span class="gray branding-text">BattleWriter</span>
</div>

<script>
  addEventListener('DOMContentLoaded', () => {
    document.getElementById('end-sprint').addEventListener('click', () => {
      poll({closeSprint: true});
    });
    document.getElementById('clear-history').addEventListener('click', () => {
      poll({clearHistory: true});
    });
    poll({});
    setInterval(() => { poll({}); }, 2000);
  });

  function eraseChildren(e) {
    while (e.childNodes.length) {
      e.removeChild(e.childNodes[0]);
    }
  }

  function poll(cmd) {
    google.script.run
            .withSuccessHandler(
                    function(state) {
                      const now = Date.now();

                      let display = 'Word Count: ~' + parseInt(state.lastWordCount) + '.\n';

                      if (state.currentSprint) {
                        const cur = state.currentSprint;
                        cur.wpm = 0;
                        // use now instead of endTime... while the sprint is still current
                        // endTime is just the last time the wordCount changed.
                        if (cur.endWordCount > cur.startWordCount && now > cur.startTime) {
                          const minutes = (now - cur.startTime) / 1000 / 60;
                          cur.wpm = (cur.endWordCount - cur.startWordCount) / minutes;
                        }

                        display += 'Writing At: ' + cur.wpm + ' WPM' + '.\n\n';
                      } else {
                        display += 'Currently taking a break.\n\n';
                      }

                      const history = []

                      for (const key in state) {
                        if (key.startsWith('sprint:')) {
                          history.push(key);
                        }
                      }

                      if (history.length > 0) {
                        history.sort().reverse();

                        display += '-- Historical Writing Sprints --\n\n';

                        for (const key of history) {
                          const s = state[key];
                          const d = new Date(s.endTime);
                          const m = (s.endTime - s.startTime) / 1000 / 60;
                          display += d.toLocaleDateString() + ' ' + d.toLocaleTimeString() + '.\n';
                          display += '  - ' + parseInt(s.endWordCount - s.startWordCount) + ' words.\n';
                          display += '  - ' + (parseInt(m * 100) / 100) + ' minutes.\n';
                          display += '  - ' + parseInt((s.endWordCount - s.startWordCount) / m) + ' WPM.\n\n';
                        }
                      }

                      display += '-- Raw BattleWriter State Data --\n\n'

                      display += JSON.stringify(state, null, 2);

                      const bwdata = document.getElementById('bwdata');
                      eraseChildren(bwdata);
                      bwdata.appendChild(document.createTextNode(display));

                      const endSprint = document.getElementById('end-sprint');
                      if (state.currentSprint) {
                        const secsLeft = parseInt((5 * 60) - ((now - state.currentSprint.endTime) / 1000));
                        eraseChildren(endSprint);
                        endSprint.appendChild(document.createTextNode(`End Sprint (${secsLeft} s)`))
                        endSprint.style.display = 'inline';
                      } else {
                        endSprint.style.display = 'none';
                      }
                    })
            .poll(cmd);
  }
</script>
</body>
</html>
